// STL includes
#include <vector>
#include <string>

// C includes

// Library includes
#include <cxxtest/TestSuite.h>

// Project includes
#include <Updater.h>
#include <IUpdate.h>

using namespace std;

class UpdateTestSuite: public CxxTest::TestSuite
{
  struct GetsUpdated: public IUpdate
  {
    int was_updated;
    GetsUpdated(void): was_updated(0) 
    {
    }
    void update(void) 
    {
      ++was_updated;
    }
  };

  GetsUpdated* p;
  Updater* pmanager;
public:
  void setUp()
  {
    p = new GetsUpdated();
    pmanager = new Updater();
  }

  void tearDown()
  {
    delete p;
    delete pmanager;
  }

  void testEmptyObject( void )
  {
    TS_ASSERT_EQUALS( p->was_updated, 0 );
  }
  
  void testUpdate( void )
  {
    IUpdate* piu = dynamic_cast<IUpdate*>(p);
    piu->update();

    TS_ASSERT_EQUALS( p->was_updated, 1 );
  }

  void testEmptyUpdateManager( void )
  {
    TS_ASSERT_EQUALS( pmanager->size(), 0 );
  }
  
  void testAddAnItem( void )
  {
    pmanager->add(p);
    TS_ASSERT_EQUALS( pmanager->size(), 1 );
  }
  
  void testUpdateViaManager( void )
  {
    pmanager->add(p);
    pmanager->update();
    TS_ASSERT_EQUALS( p->was_updated, 1 );
  }

  void testMultipleUpdates( void )
  {
    pmanager->add(p);
    pmanager->add(p);
    pmanager->add(p);
    pmanager->update();
    
    TS_ASSERT_EQUALS( p->was_updated, 3 );
  }
  
  void testMaxUpdates( void )
  {
    // Even if we TRY to update one too many objects, we will still only
    // add 'max_objects' objects

    int i = Updater::max_objects + 1;
    while (i--)
      pmanager->add(p);
    
    pmanager->update();
    
    TS_ASSERT_EQUALS( p->was_updated, Updater::max_objects );
  }
};
// vim:cin:ai:sts=2 sw=2 ft=cpp
